


    # ai_analyst.py
# [V10 Masterpiece] ê³ ì„±ëŠ¥ í˜ë¥´ì†Œë‚˜ í”„ë¡¬í”„íŠ¸ ë³µêµ¬ + JSON íŒŒì‹± ì•ˆì „ì¥ì¹˜

import json
import requests
import re
import warnings
import os
import config

# [1] ê²½ê³  ë©”ì‹œì§€ ì°¨ë‹¨
os.environ["GRPC_VERBOSITY"] = "ERROR"
warnings.filterwarnings("ignore")

import openai
import google.generativeai as genai
from anthropic import Anthropic

class AIAnalyst:
    def __init__(self):
        print("\nğŸ” [AI Analyst] ì´ˆê¸°í™” ë° ëª¨ë¸ëª… ì ê²€...")
        
        # 1. ChatGPT (ì˜ì¥)
        self.openai_client = openai.OpenAI(api_key=config.OPENAI_API_KEY)
        
        # 2. Gemini (ê³µê²©ìˆ˜)
        genai.configure(api_key=config.GOOGLE_API_KEY)
        bull_model = config.MODEL_BULL.strip()
        print(f"   ğŸ‘‰ Gemini Model: '{bull_model}' (ê³µê²©ìˆ˜)") 
        self.gemini_model = genai.GenerativeModel(bull_model)
        
        # 3. Claude (ìˆ˜ë¹„ìˆ˜)
        bear_model = config.MODEL_BEAR.strip()
        print(f"   ğŸ‘‰ Claude Model: '{bear_model}' (ìˆ˜ë¹„ìˆ˜)")
        self.claude_client = Anthropic(api_key=config.ANTHROPIC_API_KEY)

    # ---------------------------------------------------------
    # ğŸ“° 1. ë‰´ìŠ¤ ë°ì´í„° ìˆ˜ì§‘ (CryptoPanic V2)
    # ---------------------------------------------------------
    def get_crypto_news(self):
        base_url = "https://cryptopanic.com/api/developer/v2/posts/"
        params = {
            "auth_token": config.CRYPTOPANIC_API_KEY,
            "public": "true",
            "filter": "hot",
            "kind": "news"
        }
        
        try:
            if not config.CRYPTOPANIC_API_KEY: return "API Key missing."
            
            resp = requests.get(base_url, params=params, timeout=10)
            data = resp.json()
            
            if 'results' not in data: return "News fetch failed."

            news_list = [post['title'] for post in data['results']]
            if not news_list: return "No news found."
            
            print(f"ğŸ“° [News] V2 APIë¡œ ë‰´ìŠ¤ {len(news_list)}ê±´ ìˆ˜ì§‘ ì™„ë£Œ")
            return "\n".join(news_list)

        except:
            return "Market data unavailable."

    def get_fear_greed_index(self):
        try:
            url = "https://api.alternative.me/fng/"
            resp = requests.get(url, timeout=5).json()
            return int(resp['data'][0]['value'])
        except:
            return 50

    # ---------------------------------------------------------
    # ğŸ”§ 2. JSON íŒŒì‹± ë° ë°ì´í„° ë³´ì • (ê°•ë ¥í•¨ ìœ ì§€)
    # ---------------------------------------------------------
    def _parse_json(self, text):
        try:
            # 1. ë§ˆí¬ë‹¤ìš´ ë° ê³µë°± ì œê±°
            text = re.sub(r'```json\s*', '', text)
            text = re.sub(r'```', '', text)
            text = text.strip()
            
            # 2. ì¤‘ê´„í˜¸ {} ì¶”ì¶œ (ì¡ë‹´ ì œê±°)
            start_index = text.find('{')
            end_index = text.rfind('}')
            if start_index != -1 and end_index != -1:
                text = text[start_index : end_index + 1]
            else:
                return None
            
            # 3. JSON ë³€í™˜
            data = json.loads(text)

            # 4. ì†ì ˆê°€ ìŒìˆ˜ ë³´ì •
            if 'STOP_LOSS' in data:
                sl = float(data['STOP_LOSS'])
                if sl > 0: data['STOP_LOSS'] = -sl
                
            return data

        except Exception as e:
            print(f"ğŸš¨ [JSON íŒŒì‹± ì‹¤íŒ¨] ë‚´ìš©: {text[:50]}... ì›ì¸: {e}")
            return None

    # ---------------------------------------------------------
    # ğŸ¦ 3. Gemini (ê³µê²©ìˆ˜) - í”„ë¡¬í”„íŠ¸ ë³µêµ¬ ì™„ë£Œ
    # ---------------------------------------------------------
    def ask_gemini_bull(self, news, fng):
        prompt = f"""
        Role: You are a **High-Frequency Trading (HFT) Alpha Strategist**.
        Your Motto: "Volatility is opportunity. We buy the fear and ride the momentum."
        
        [Market Context]
        - FNG Index: {fng}
        - News:
        {news}
        
        [Task]
        Analyze the news for potential upside catalysts.
        Propose **aggressive** trading parameters to maximize profit.
        
        [Guidelines]
        1. **RSI_BUY**: Higher values (40-55). Catch the rebound early.
        2. **STOP_LOSS**: Loose stops (-3.0% to -6.0%). Give room to breathe.
        3. **KIMP_MAX**: High tolerance (5.0% - 10.0%). Ride the buying pressure.
        
        [Output Format]
        Return ONLY a JSON object:
        {{
            "RSI_BUY": (int),
            "STOP_LOSS": (float, negative),
            "KIMP_MAX": (float),
            "BEP_TICKS": (int)
        }}
        """
        try:
            resp = self.gemini_model.generate_content(prompt)
            return self._parse_json(resp.text)
        except Exception as e:
            print(f"âš ï¸ [Gemini] ì˜¤ë¥˜: {e}")
            return None

    # ---------------------------------------------------------
    # ğŸ¢ 4. Claude (ìˆ˜ë¹„ìˆ˜) - í”„ë¡¬í”„íŠ¸ ë³µêµ¬ ì™„ë£Œ
    # ---------------------------------------------------------
    def ask_claude_bear(self, news, fng):
        prompt = f"""
        Role: You are the **Chief Risk Officer (CRO)** of a conservative hedge fund.
        Your Motto: "Capital preservation comes first. Better to miss a trade than lose money."
        
        [Market Context]
        - FNG Index: {fng}
        - News:
        {news}
        
        [Task]
        Analyze the news for potential risks (hacks, regulation, macro).
        Propose **strictly defensive** trading parameters.
        
        [Guidelines]
        1. **RSI_BUY**: Low values (20-30). Buy only on extreme oversold.
        2. **STOP_LOSS**: Tight stops (-0.5% to -2.0%). Cut losses immediately.
        3. **KIMP_MAX**: Low tolerance (1.0% - 3.0%). Avoid bubbles.
        
        [Output Format]
        Return ONLY a JSON object:
        {{
            "RSI_BUY": (int),
            "STOP_LOSS": (float, negative),
            "KIMP_MAX": (float),
            "BEP_TICKS": (int)
        }}
        """
        try:
            msg = self.claude_client.messages.create(
                model=config.MODEL_BEAR.strip(),
                max_tokens=250,
                messages=[{"role": "user", "content": prompt}]
            )
            return self._parse_json(msg.content[0].text)
        except Exception as e:
            print(f"âš ï¸ [Claude] ì˜¤ë¥˜: {e}")
            return None

    # ---------------------------------------------------------
    # âš–ï¸ 5. ì˜ì¥(ChatGPT) ìµœì¢… í•©ì˜
    # ---------------------------------------------------------
    def ask_gpt_chairman(self, news, fng, bull_view, bear_view):
        prompt = f"""
        Role: Chief Investment Officer (CIO).
        Context: FNG {fng}, News: {news[:500]}
        Opinions: 
        - Bull (Aggressive): {bull_view}
        - Bear (Conservative): {bear_view}

        Task: Synthesize these opinions and decide the FINAL strategy.
        
        Logic:
        - Negative News -> Lean towards Bear.
        - Positive News -> Lean towards Bull.
        - Mixed/Ambiguous -> Balanced approach.

        Output JSON: 
        {{ 
            "RSI_BUY_THRESHOLD": int, 
            "MAX_KIMP_THRESHOLD": float, 
            "STOP_LOSS_PCT": float, 
            "MAX_TICKS_FOR_BEP": int, 
            "PARTIAL_SELL_MIN_PROFIT": float, 
            "TRAILING_START": float, 
            "REASON": str 
        }}
        """
        try:
            resp = self.openai_client.chat.completions.create(
                model=config.MODEL_CHAIRMAN,
                messages=[{"role": "user", "content": prompt}],
                response_format={"type": "json_object"}
            )
            return json.loads(resp.choices[0].message.content)
        except Exception as e:
            print(f"âš ï¸ [Chairman] í•©ì˜ ì‹¤íŒ¨: {e}")
            return None

    # ---------------------------------------------------------
    # ğŸš€ ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
    # ---------------------------------------------------------
    def get_consensus_params(self):
        print("\nğŸ§  [AI Analyst] 3ëŒ€ AI ìœ„ì›íšŒ ì†Œì§‘ (News+Gemini+Claude+GPT)...")
        
        news = self.get_crypto_news()
        fng = self.get_fear_greed_index()
        
        bull = self.ask_gemini_bull(news, fng)
        bear = self.ask_claude_bear(news, fng)
        
        if not bull or not bear:
            print("âš ï¸ ìœ„ì› ì˜ê²¬ ìˆ˜ë ´ ì‹¤íŒ¨ -> ê¸°ë³¸ ë¡œì§ ì‚¬ìš©")
            return None

        print(f"   - ğŸ¦ Gemini(ê³µê²©): RSI {bull.get('RSI_BUY')}, ì†ì ˆ {bull.get('STOP_LOSS')}%")
        print(f"   - ğŸ¢ Claude(ìˆ˜ë¹„): RSI {bear.get('RSI_BUY')}, ì†ì ˆ {bear.get('STOP_LOSS')}%")

        final_decision = self.ask_gpt_chairman(news, fng, bull, bear)
        
        if final_decision:
            print(f"   ğŸ‘¨â€âš–ï¸ ì˜ì¥(GPT) ìµœì¢… ìŠ¹ì¸: RSI {final_decision['RSI_BUY_THRESHOLD']}, "
                  f"ì†ì ˆ {final_decision['STOP_LOSS_PCT']}%, "
                  f"ì´ìœ : {final_decision['REASON']}")
            return final_decision
        else:
            return None

if __name__ == "__main__":
    ai = AIAnalyst()
    print(ai.get_consensus_params())